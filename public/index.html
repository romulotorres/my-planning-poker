<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planning Poker Elite</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
      :root {
        --primary: #2c3e50;
        --gold: #f1c40f;
        --table: #1b5e20;
        --bg: #121212;
        --card-bg: #2e2e2e;
        --danger: #e74c3c;
        --input: #444;
        --inputBorder: #000;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: white;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-x: hidden;
      }

      #conn-status {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: var(--danger);
        color: white;
        text-align: center;
        padding: 10px;
        font-weight: bold;
        z-index: 9999;
        display: none;
      }

      #room-info {
        position: fixed;
        left: 20px;
        top: 20px;
        background: rgba(30, 30, 30, 0.95);
        padding: 10px 15px;
        border-radius: 10px;
        border: 1px solid #444;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 10;
      }

      .poker-area {
        position: relative;
        width: 700px;
        height: 350px;
        margin: 40px auto 60px;
      }
      .table-surface {
        position: absolute;
        width: 100%;
        height: 100%;
        background: var(--table);
        border: 12px solid #3e2723;
        border-radius: 180px;
        box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.7);
      }

      .player-slot {
        position: absolute;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 120px;
        z-index: 5;
      }
      .player-name {
        font-size: 11px;
        margin-top: 3px;
        max-width: 100px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin: 3px auto;
      }

      .avatar {
        width: 45px;
        height: 45px;
        background: #689;
        border-radius: 50%;
        margin: 0 auto 5px;
        border: 2px solid #555;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        position: relative;
      }
      .is-adm {
        border-color: var(--gold);
        box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
      }
      .adm-crown {
        position: absolute;
        top: -14px;
        font-size: 16px;
      }

      .card-slot {
        width: 38px;
        height: 55px;
        background: #fff;
        border-radius: 4px;
        margin: 5px auto;
        color: #222;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      }
      .card-hidden {
        background: linear-gradient(
          135deg,
          #c62828 25%,
          #b71c1c 25%,
          #b71c1c 50%,
          #c62828 50%,
          #c62828 75%,
          #b71c1c 75%,
          #b71c1c 100%
        );
        background-size: 8px 8px;
      }

      .side-panel {
        position: fixed;
        right: 15px;
        top: 15px;
        width: 160px;
        background: rgba(30, 30, 30, 0.95);
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #444;
        text-align: center;
        z-index: 10;
      }

      .history-section {
        width: 700px;
        margin: 40px auto 140px;
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      td {
        padding: 10px;
        border-bottom: 1px solid #333;
        text-align: center;
        font-size: 14px;
      }
      tr:first-child td {
        color: var(--gold);
        font-weight: bold;
        background: rgba(241, 196, 15, 0.05);
      }

      .controls {
        background: #181818;
        padding: 15px 0;
        width: 100vw;
        position: fixed;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        border-top: 2px solid #333;
        z-index: 100;
      }
      .fib-card {
        width: 42px;
        height: 62px;
        background: white;
        color: #333;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
      }
      .fib-card.active {
        background: #2196f3;
        color: white;
        transform: translateY(-8px);
      }
      .btn-action {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        font-weight: bold;
        cursor: pointer;
      }
      .btn-action:hover {
        opacity: 0.7;
      }
      #username,
      #roomName {
        background: var(--input);
        border: 1px solid var(--inputBorder);
        color: white;
        border-radius: 6px;
      }
      input[type="checkbox"] {
        transform: scale(1.5); /* Aumenta o tamanho para 150% do original */
        margin: 10px; /* Adiciona margem para compensar o tamanho maior */
      }
    </style>
  </head>
  <body>
    <div id="conn-status">
      ‚ö†Ô∏è Conex√£o perdida. <button onclick="socket.connect()">Reconectar</button>
    </div>

    <div
      id="login-screen"
      style="
        margin-top: 60px;
        text-align: center;
        background: var(--card-bg);
        padding: 40px;
        border-radius: 15px;
      "
    >
      <h2>üÉè Poker Sprint Pro</h2>
      <input
        type="text"
        id="username"
        placeholder="Seu apelido..."
        maxlength="50"
        style="padding: 12px; width: 250px; margin-bottom: 10px"
      />
      <br />
      <input
        type="text"
        id="roomName"
        placeholder="Nome da sala..."
        style="padding: 12px; width: 250px; margin-bottom: 15px"
      />
      <br />
      <label style="cursor: pointer; display: block; margin-bottom: 20px"
        ><input type="checkbox" id="isSpectator" /> Apenas observar üëÅÔ∏è</label
      >
      <button
        class="btn-action"
        style="background: var(--table); color: white"
        onclick="join()"
      >
        ENTRAR NA MESA
      </button>
    </div>

    <div id="game-screen" style="display: none; width: 100%">
      <div id="room-info">
        <span
          id="display-room-name"
          style="font-weight: bold; color: var(--gold)"
          >SALA: -</span
        >
        <button
          class="btn-action"
          style="
            background: #555;
            color: white;
            font-size: 11px;
            padding: 5px 8px;
          "
          id="btn-copy"
          onclick="copyLink()"
        >
          Copiar Link üîó
        </button>
      </div>

      <div class="side-panel">
        <span
          id="agg-text"
          style="color: var(--gold); font-size: 13px; font-weight: bold"
          >Concord√¢ncia: 0%</span
        >
        <canvas id="chartVotes"></canvas>
      </div>

      <div class="poker-area">
        <div class="table-surface"></div>
        <div id="players-container"></div>
      </div>

      <div class="history-section">
        <h3 style="margin-top: 0">üìú Hist√≥rico da Sess√£o</h3>
        <table>
          <tbody id="history-body"></tbody>
        </table>
      </div>

      <div class="controls">
        <div id="cards-deck" style="display: flex; gap: 8px"></div>
        <div
          id="admin-controls"
          style="
            display: none;
            border-left: 2px solid #444;
            padding-left: 15px;
            margin-left: 10px;
          "
        >
          <button
            class="btn-action"
            style="background: #4caf50; color: white; margin-right: 8px"
            onclick="reveal()"
          >
            REVELAR
          </button>
          <button
            class="btn-action"
            style="background: #f44336; color: white"
            onclick="reset()"
          >
            LIMPAR
          </button>
        </div>
        <button
          class="btn-action"
          style="background: #444; color: white; font-size: 18px"
          onclick="changeName()"
        >
          ‚úèÔ∏è
        </button>
      </div>
    </div>

    <script>
      const socket = io();
      const fibCards = [1, 2, 3, 5, 8, 13, 21, 34, 55, 89, "‚òï", "?"];
      let currentRoomId = "",
        myVote = null,
        chart = null,
        currentAverage = "-",
        isSpectatorMode = false;

      if (window.location.hash)
        document.getElementById("roomName").value = decodeURIComponent(
          window.location.hash.substring(1),
        );

      socket.on("disconnect", () => {
        document.getElementById("conn-status").style.display = "block";
      });
      socket.on("connect", () => {
        document.getElementById("conn-status").style.display = "none";
        if (currentRoomId) join();
      });

      const centerTextPlugin = {
        id: "centerText",
        afterDraw: (chart) => {
          const {
            ctx,
            chartArea: { top, left, width, height },
          } = chart;
          ctx.save();
          ctx.font = "bold 22px Segoe UI";
          ctx.fillStyle = "#f1c40f";
          ctx.textAlign = "center";
          ctx.fillText(currentAverage, left + width / 2, top + height / 2 + 5);
          ctx.restore();
        },
      };

      function join() {
        const name = document.getElementById("username").value;
        const room = document
          .getElementById("roomName")
          .value.trim()
          .replace(/\s+/g, "-");
        isSpectatorMode = document.getElementById("isSpectator").checked;
        if (!name || !room) return;
        currentRoomId = room;
        window.location.hash = room;
        document.getElementById("display-room-name").innerText =
          `SALA: ${room.toUpperCase()}`;
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("game-screen").style.display = "block";
        if (isSpectatorMode)
          document.getElementById("cards-deck").style.display = "none";
        socket.emit("join-room", {
          roomId: room,
          userName: name,
          isSpectator: isSpectatorMode,
        });
        renderDeck();
      }

      function copyLink() {
        navigator.clipboard.writeText(window.location.href).then(() => {
          document.getElementById("btn-copy").innerText = "Copiado! ‚úÖ";
          setTimeout(
            () =>
              (document.getElementById("btn-copy").innerText =
                "Copiar Link üîó"),
            2000,
          );
        });
      }

      function changeName() {
        const n = prompt(
          "Novo apelido:",
          document.getElementById("username").value,
        );
        if (n) {
          document.getElementById("username").value = n;
          socket.emit("change-name", { roomId: currentRoomId, newName: n });
        }
      }

      function renderDeck() {
        if (isSpectatorMode) return;
        const deck = document.getElementById("cards-deck");
        deck.innerHTML = "";
        fibCards.forEach((val) => {
          const b = document.createElement("button");
          b.className = `fib-card ${myVote === val ? "active" : ""}`;
          b.innerText = val;
          b.onclick = () => {
            myVote = val;
            socket.emit("cast-vote", { roomId: currentRoomId, vote: val });
            renderDeck();
          };
          deck.appendChild(b);
        });
      }

      socket.on("update-room", (data) => {
        const container = document.getElementById("players-container");
        container.innerHTML = "";
        const users = Object.entries(data.users);
        users.forEach(([id, user], i) => {
          const angle = (i / users.length) * 2 * Math.PI;
          const x = 350 + 290 * Math.cos(angle);
          const y = 175 + 115 * Math.sin(angle);
          const slot = document.createElement("div");
          slot.className = "player-slot";
          slot.style.left = x + "px";
          slot.style.top = y + "px";
          slot.innerHTML = `
                    <div class="avatar ${id === data.adminId ? "is-adm" : ""}">
                        ${id === data.adminId ? '<span class="adm-crown">üëë</span>' : ""}
                        ${user.isSpectator ? "üëÅÔ∏è" : "üë§"}
                    </div>
                    <div class="player-name">${user.name}</div>
                    ${!user.isSpectator ? `<div class="card-slot ${data.revealed ? "" : user.vote ? "card-hidden" : ""}">${data.revealed ? user.vote || "-" : ""}</div>` : ""}
                `;
          container.appendChild(slot);
        });
        document.getElementById("admin-controls").style.display =
          socket.id === data.adminId ? "block" : "none";
        if (data.revealed) processStats(data);
      });

      socket.on("clear-local-votes", () => {
        myVote = null;
        currentAverage = "-";
        document.getElementById("agg-text").innerText = "Concord√¢ncia: 0%";
        if (chart) {
          chart.destroy();
          chart = null;
        }
        renderDeck();
      });

      function processStats(data) {
        const votes = Object.values(data.users)
          .filter((u) => !u.isSpectator && u.vote !== null)
          .map((u) => u.vote);
        if (!votes.length) return;

        const nums = votes.filter((v) => typeof v === "number");
        currentAverage = nums.length
          ? (nums.reduce((a, b) => a + b, 0) / nums.length).toFixed(1)
          : "-";

        const counts = {};
        votes.forEach((v) => (counts[v] = (counts[v] || 0) + 1));
        const distinctVotes = Object.keys(counts).length;
        const agreement = Math.round((1 / distinctVotes) * 100);
        document.getElementById("agg-text").innerText =
          `Concord√¢ncia: ${agreement}%`;

        if (agreement === 100 && votes.length > 1) {
          confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            zIndex: 1000,
          });
        }

        // Atualiza Tabela Hist√≥rico
        const tbody = document.getElementById("history-body");
        const row = tbody.insertRow(0);
        row.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>M√©dia: ${currentAverage}</td><td>Votos: ${votes.join(", ")}</td>`;

        // Desenha Gr√°fico
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById("chartVotes"), {
          type: "doughnut",
          data: {
            labels: Object.keys(counts),
            datasets: [
              {
                data: Object.values(counts),
                backgroundColor: ["#42a5f5", "#ef5350", "#ffca28", "#66bb6a"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || ""; // O valor da pontua√ß√£o (ex: 5)
                    const value = context.raw || 0; // A quantidade de votos (ex: 2)
                    return `Pontua√ß√£o ${label} - ${value} votos`;
                  },
                },
              },
            },
            cutout: "75%",
          },
          plugins: [centerTextPlugin],
        });
      }

      function reveal() {
        socket.emit("reveal-votes", currentRoomId);
      }
      function reset() {
        socket.emit("reset-game", currentRoomId);
      }
    </script>
  </body>
</html>
