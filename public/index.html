<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planning Poker Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
      :root {
        --primary: #2c3e50;
        --gold: #f1c40f;
        --table: #1b5e20;
        --bg: #121212;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: white;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-x: hidden;
      }

      /* Login */
      #login-screen {
        background: #1e1e1e;
        padding: 40px;
        border-radius: 15px;
        margin-top: 100px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        text-align: center;
      }
      input[type="text"] {
        padding: 12px;
        border-radius: 5px;
        border: none;
        margin-bottom: 10px;
        width: 250px;
        font-size: 16px;
      }

      /* Mesa */
      .poker-area {
        position: relative;
        width: 850px;
        height: 450px;
        margin: 40px auto;
      }
      .table-surface {
        position: absolute;
        width: 100%;
        height: 100%;
        background: var(--table);
        border: 12px solid #3e2723;
        border-radius: 220px;
        box-shadow: inset 0 0 60px rgba(0, 0, 0, 0.7);
      }

      .player-slot {
        position: absolute;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 110px;
        transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .avatar {
        width: 55px;
        height: 55px;
        background: #333;
        border-radius: 50%;
        margin: 0 auto 5px;
        border: 3px solid #777;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        position: relative;
      }
      .is-adm {
        border-color: var(--gold);
        box-shadow: 0 0 15px rgba(241, 196, 15, 0.4);
      }
      .adm-crown {
        position: absolute;
        top: -15px;
        font-size: 18px;
      }

      .card-slot {
        width: 45px;
        height: 65px;
        background: #eee;
        border-radius: 6px;
        margin: 8px auto;
        color: #222;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.6s;
        border: 1px solid #aaa;
      }
      .card-hidden {
        background: linear-gradient(
          135deg,
          #c62828 25%,
          #b71c1c 25%,
          #b71c1c 50%,
          #c62828 50%,
          #c62828 75%,
          #b71c1c 75%,
          #b71c1c 100%
        );
        background-size: 10px 10px;
      }
      .revealed {
        transform: rotateY(360deg);
        background: white;
        font-size: 20px;
      }

      /* Controles */
      .controls {
        background: #1e1e1e;
        padding: 15px;
        width: 100%;
        position: fixed;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        border-top: 1px solid #333;
        z-index: 100;
      }
      .fib-card {
        width: 48px;
        height: 72px;
        background: white;
        color: #333;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        transition: 0.2s;
        box-shadow: 0 4px 0 #999;
      }
      .fib-card:hover {
        transform: translateY(-8px);
        background: var(--gold);
        box-shadow: 0 4px 0 #b8960d;
      }
      .fib-card.active {
        background: #2196f3;
        color: white;
        box-shadow: 0 4px 0 #0d47a1;
      }

      .btn-action {
        padding: 12px 20px;
        border-radius: 6px;
        border: none;
        font-weight: bold;
        cursor: pointer;
        margin: 0 5px;
      }
      .btn-reveal {
        background: #4caf50;
        color: white;
      }
      .btn-reset {
        background: #f44336;
        color: white;
      }

      /* Stats e Hist√≥rico */
      .side-panel {
        position: fixed;
        right: 20px;
        top: 20px;
        width: 220px;
        background: rgba(30, 30, 30, 0.9);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #333;
      }
      .history-section {
        width: 850px;
        margin: 20px auto 120px;
        background: #1e1e1e;
        padding: 20px;
        border-radius: 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #333;
        text-align: center;
      }
      th {
        color: var(--gold);
        text-transform: uppercase;
        font-size: 12px;
      }
      .tag-vote {
        background: #333;
        padding: 3px 8px;
        border-radius: 4px;
        margin: 2px;
        font-size: 12px;
        border: 1px solid #444;
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <h2>üÉè Poker Sprint</h2>
      <input type="text" id="username" placeholder="Seu apelido..." /><br />
      <label style="display: block; margin: 10px 0">
        <input type="checkbox" id="isSpectator" /> Entrar como Observador
      </label>
      <button class="btn-action btn-reveal" onclick="join()">
        Entrar na Sala
      </button>
    </div>

    <div id="game-screen" style="display: none">
      <div class="side-panel">
        <h3 id="agg-text" style="margin: 0 0 10px 0; font-size: 16px">
          Concord√¢ncia: 0%
        </h3>
        <canvas id="chartVotes" width="200" height="200"></canvas>
        <div
          id="average-text"
          style="margin-top: 10px; font-weight: bold; color: var(--gold)"
        ></div>
      </div>

      <div class="poker-area">
        <div class="table-surface"></div>
        <div id="players-container"></div>
      </div>

      <div class="history-section">
        <h3 style="margin: 0">üìú Hist√≥rico da Sess√£o</h3>
        <table>
          <thead>
            <tr>
              <th>Hora</th>
              <th>M√©dia</th>
              <th>Concord√¢ncia</th>
              <th>Distribui√ß√£o</th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>

      <div class="controls">
        <div id="cards-deck" style="display: flex; gap: 8px"></div>
        <div
          style="width: 2px; height: 50px; background: #333; margin: 0 15px"
        ></div>
        <div id="admin-controls" style="display: none">
          <button class="btn-action btn-reveal" onclick="reveal()">
            REVELAR üëÅÔ∏è
          </button>
          <button class="btn-action btn-reset" onclick="reset()">
            LIMPAR üßπ
          </button>
        </div>
        <button
          class="btn-action"
          style="background: #555; color: white"
          onclick="changeName()"
        >
          ‚úèÔ∏è
        </button>
      </div>
    </div>

    <script>
      const socket = io();
      const fibCards = [1, 2, 3, 5, 8, 13, 21, 34, 55, 89, "‚òï", "?"];
      let currentRoom = window.location.hash || "#scrum-master";
      let myVote = null;
      let chart = null;
      let lastHistoryId = null;

      function join() {
        const name = document.getElementById("username").value;
        const spec = document.getElementById("isSpectator").checked;
        if (!name) return alert("Qual o seu nome?");

        document.getElementById("login-screen").style.display = "none";
        document.getElementById("game-screen").style.display = "block";
        socket.emit("join-room", {
          roomId: currentRoom,
          userName: name,
          isSpectator: spec,
        });
        renderDeck();
      }

      function renderDeck() {
        const deck = document.getElementById("cards-deck");
        deck.innerHTML = "";
        fibCards.forEach((val) => {
          const b = document.createElement("button");
          b.className = `fib-card ${myVote === val ? "active" : ""}`;
          b.innerText = val;
          b.onclick = () => {
            myVote = val;
            socket.emit("cast-vote", { roomId: currentRoom, vote: val });
            renderDeck();
          };
          deck.appendChild(b);
        });
      }

      socket.on("update-room", (data) => {
        const container = document.getElementById("players-container");
        container.innerHTML = "";
        const usersEntries = Object.entries(data.users);

        usersEntries.forEach(([id, user], index) => {
          const angle = (index / usersEntries.length) * 2 * Math.PI;
          const x = 425 + 340 * Math.cos(angle);
          const y = 225 + 160 * Math.sin(angle);

          const slot = document.createElement("div");
          slot.className = "player-slot";
          slot.style.left = x + "px";
          slot.style.top = y + "px";

          const isAdm = id === data.adminId;
          const hasVoted = user.vote !== null;
          const voteVal = data.revealed ? user.vote : hasVoted ? "" : "";

          slot.innerHTML = `
                    <div class="avatar ${isAdm ? "is-adm" : ""}">
                        ${isAdm ? '<span class="adm-crown">üëë</span>' : ""}
                        ${user.isSpectator ? "üëÅÔ∏è" : "üë§"}
                    </div>
                    <div style="font-size:12px; font-weight:bold;">${user.name}</div>
                    ${
                      !user.isSpectator
                        ? `
                        <div class="card-slot ${data.revealed ? "revealed" : hasVoted ? "card-hidden" : ""}">
                            ${data.revealed ? user.vote || "-" : ""}
                        </div>
                    `
                        : '<div style="font-size:10px; color:#aaa; margin-top:10px;">ESPECTADOR</div>'
                    }
                `;
          container.appendChild(slot);
        });

        document.getElementById("admin-controls").style.display =
          socket.id === data.adminId ? "block" : "none";

        if (data.revealed) {
          processStats(data);
        } else {
          if (chart) chart.destroy();
          document.getElementById("average-text").innerText = "";
          document.getElementById("agg-text").innerText = "Concord√¢ncia: 0%";
        }
      });

      function processStats(data) {
        const votes = [];
        const counts = {};

        Object.values(data.users).forEach((u) => {
          if (!u.isSpectator && u.vote) {
            votes.push(u.vote);
            counts[u.vote] = (counts[u.vote] || 0) + 1;
          }
        });

        if (votes.length === 0) return;

        // M√©dia
        const numericVotes = votes.filter((v) => typeof v === "number");
        const avg = numericVotes.length
          ? (
              numericVotes.reduce((a, b) => a + b, 0) / numericVotes.length
            ).toFixed(1)
          : "-";
        document.getElementById("average-text").innerText = `M√©dia: ${avg}`;

        // Concord√¢ncia
        const maxGroup = Math.max(...Object.values(counts));
        const totalVoters = Object.values(data.users).filter(
          (u) => !u.isSpectator,
        ).length;
        const agreement = Math.round((maxGroup / totalVoters) * 100);
        document.getElementById("agg-text").innerText =
          `Concord√¢ncia: ${agreement}%`;

        if (agreement === 100 && totalVoters > 1) {
          confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        // Gr√°fico
        const ctx = document.getElementById("chartVotes").getContext("2d");
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(counts),
            datasets: [
              {
                data: Object.values(counts),
                backgroundColor: [
                  "#FF6384",
                  "#36A2EB",
                  "#FFCE56",
                  "#4BC0C0",
                  "#9966FF",
                ],
              },
            ],
          },
          options: { plugins: { legend: { display: false } }, cutout: "70%" },
        });

        // Hist√≥rico (evitar duplicar)
        if (data.revealedAt && data.revealedAt !== lastHistoryId) {
          updateHistory(avg, agreement, counts);
          lastHistoryId = data.revealedAt;
        }
      }

      function updateHistory(avg, agg, counts) {
        const tbody = document.getElementById("history-body");
        const row = document.createElement("tr");
        const dist = Object.entries(counts)
          .map(([v, c]) => `<span class="tag-vote">${v} (x${c})</span>`)
          .join("");
        row.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>${avg}</td><td>${agg}%</td><td>${dist}</td>`;
        tbody.prepend(row);
      }

      function reveal() {
        socket.emit("reveal-votes", currentRoom);
      }
      function reset() {
        myVote = null;
        socket.emit("reset-game", currentRoom);
        renderDeck();
      }
      function changeName() {
        const n = prompt("Novo nome:");
        if (n) socket.emit("change-name", { roomId: currentRoom, newName: n });
      }
    </script>
  </body>
</html>
